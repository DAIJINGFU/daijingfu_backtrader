# 聚宽回测模块 - 隔离开发方案

## 📋 概述

本文档提供了将聚宽回测模块（JoinQuant Backtest Module）抽离为独立开发包的完整方案，允许外部实习生基于统一接口和数据环境进行独立开发，最后可无缝集成回主系统。

---

## 🎯 目标

1. **隔离性**: 实习生无法接触主系统的其他核心代码
2. **接口统一**: 遵循相同的API规范和数据接口
3. **独立开发**: 可独立运行、测试、调试
4. **无缝集成**: 开发完成后可直接替换现有模块
5. **环境一致**: 使用相同的依赖和数据格式

---

## 📦 隔离包结构

### 建议项目结构

```
jq-backtest-standalone/
├── README.md                    # 开发指南
├── pyproject.toml              # 独立依赖配置
├── requirements.txt            # 依赖清单
├── .env.example               # 环境配置示例
├── docker-compose.yml         # 本地开发环境
├── docs/
│   ├── API_SPECIFICATION.md   # API规范文档
│   ├── INTEGRATION_GUIDE.md   # 集成指南
│   └── EXAMPLES.md           # 使用示例
├── tests/
│   ├── test_engine.py        # 引擎测试
│   ├── test_strategy.py      # 策略测试
│   ├── test_data_api.py      # 数据API测试
│   ├── test_trading_api.py   # 交易API测试
│   └── fixtures/             # 测试数据
│       ├── sample_data/      # CSV样本数据
│       └── sample_strategies/ # 示例策略
├── jq_backtest/              # 核心模块
│   ├── __init__.py
│   ├── engine.py             # 回测引擎（需实现）
│   ├── strategy.py           # 策略适配器（需实现）
│   ├── context.py            # 上下文对象
│   ├── portfolio.py          # 投资组合
│   ├── order.py              # 订单模型
│   ├── trading_api.py        # 交易API
│   ├── data_api.py           # 数据API
│   ├── csv_adapter.py        # CSV数据适配器（需实现）
│   ├── trading_rules.py      # 交易规则
│   └── utils.py              # 工具函数
├── interfaces/               # 接口定义（只读）
│   ├── __init__.py
│   ├── data_provider.py      # 数据提供者接口
│   └── backtest_service.py   # 回测服务接口
├── examples/                 # 示例代码
│   ├── basic_strategy.py     # 基础策略示例
│   ├── ma_crossover.py       # 均线策略
│   └── run_backtest.py       # 运行回测示例
└── scripts/
    ├── setup_env.sh          # 环境搭建脚本
    ├── run_tests.sh          # 测试脚本
    └── validate_integration.sh # 集成验证脚本
```

---

## 🔌 接口定义

### 1. 数据提供者接口 (`interfaces/data_provider.py`)

这是实习生需要遵循的核心数据接口，与主系统完全兼容：

```python
"""
数据提供者接口定义
实习生需要通过这个接口获取数据，确保与主系统兼容
"""
from abc import ABC, abstractmethod
from datetime import datetime
from typing import List, Optional
import pandas as pd


class IDataProvider(ABC):
    """数据提供者接口 - 与主系统 CSVDataProvider 兼容"""
    
    @abstractmethod
    def load_data(
        self,
        security: str,
        start_date: datetime,
        end_date: datetime,
        freq: str = 'daily',
        adjust: str = 'pre'
    ) -> pd.DataFrame:
        """
        加载单个证券的历史数据
        
        Args:
            security: 证券代码 (如 '000001.XSHE')
            start_date: 开始日期
            end_date: 结束日期
            freq: 频率 ('daily' or 'minute')
            adjust: 复权方式 ('pre', 'post', 'none')
            
        Returns:
            DataFrame with columns: datetime, open, high, low, close, volume
        """
        pass
    
    @abstractmethod
    def load_multiple(
        self,
        securities: List[str],
        start_date: datetime,
        end_date: datetime,
        freq: str = 'daily',
        adjust: str = 'pre'
    ) -> dict[str, pd.DataFrame]:
        """
        批量加载多个证券的历史数据
        
        Returns:
            字典: {security_code: DataFrame}
        """
        pass
    
    @abstractmethod
    def get_history_data(
        self,
        securities: List[str],
        count: int,
        end_date: datetime,
        freq: str = 'daily',
        fields: List[str] = None,
        fq: str = 'pre'
    ) -> pd.DataFrame:
        """
        获取历史数据（聚宽API兼容）
        
        Args:
            securities: 证券列表
            count: 数据条数
            end_date: 结束日期
            freq: 频率
            fields: 字段列表 ['open', 'close', 'high', 'low', 'volume']
            fq: 复权方式
            
        Returns:
            多索引DataFrame (datetime, security)
        """
        pass
```

### 2. 回测服务接口 (`interfaces/backtest_service.py`)

```python
"""
回测服务接口定义
这是实习生需要实现的核心接口
"""
from abc import ABC, abstractmethod
from datetime import datetime
from typing import Dict, List, Optional, Any


class IBacktestService(ABC):
    """回测服务接口 - 需要实现的核心功能"""
    
    @abstractmethod
    def run_backtest(
        self,
        strategy_code: str,
        start_date: datetime,
        end_date: datetime,
        initial_cash: float = 1000000,
        securities: Optional[List[str]] = None,
        commission: Optional[float] = None,
        stamp_duty: Optional[float] = None,
        freq: str = 'daily',
        fq: str = 'pre'
    ) -> Dict[str, Any]:
        """
        运行回测
        
        Args:
            strategy_code: 策略代码（包含initialize和handle_data函数）
            start_date: 开始日期
            end_date: 结束日期
            initial_cash: 初始资金
            securities: 证券列表（可选）
            commission: 手续费率（可选）
            stamp_duty: 印花税率（可选）
            freq: 数据频率
            fq: 复权方式
            
        Returns:
            回测结果字典，包含:
            {
                'backtest_id': str,
                'status': str,
                'initial_cash': float,
                'final_value': float,
                'total_return': float,
                'sharpe_ratio': float,
                'max_drawdown': float,
                'equity_curve': List[dict],
                'trades': List[dict],
                'positions': List[dict],
                ...
            }
        """
        pass
    
    @abstractmethod
    def validate_strategy_code(self, strategy_code: str) -> Dict[str, Any]:
        """
        验证策略代码的有效性
        
        Returns:
            {
                'valid': bool,
                'errors': List[str],
                'warnings': List[str]
            }
        """
        pass
```

---

## 📚 提供给实习生的文件

### 需要提供的完整文件清单

#### 1. 接口定义（只读）
```
interfaces/
├── __init__.py
├── data_provider.py      # ✅ 数据接口定义
└── backtest_service.py   # ✅ 服务接口定义
```

#### 2. 现有实现（参考，不修改）
```
jq_backtest/
├── context.py            # ✅ Context, g, RunParams
├── portfolio.py          # ✅ Portfolio, Position
├── order.py              # ✅ Order, OrderStyle, MarketOrder等
├── trading_api.py        # ✅ TradingAPI实现
├── data_api.py          # ✅ DataAPI实现
├── trading_rules.py      # ✅ A股交易规则
└── utils.py              # ✅ 工具函数
```

#### 3. 需要实现的核心文件
```
jq_backtest/
├── engine.py             # ⚠️ 需要实现：主引擎
├── strategy.py           # ⚠️ 需要实现：策略适配器
└── csv_adapter.py        # ⚠️ 需要实现：数据适配器
```

#### 4. 测试数据
```
tests/fixtures/
├── sample_data/
│   ├── 000001.XSHE_daily.csv      # 样本日线数据
│   ├── 000001.XSHE_minute.csv     # 样本分钟数据
│   └── 000300.XSHG_daily.csv      # 基准数据
└── sample_strategies/
    ├── simple_ma.py                # 简单均线策略
    └── buy_and_hold.py            # 买入持有策略
```

---

## 🛠 实习生开发任务

### Phase 1: 环境搭建 (1天)

1. **克隆隔离仓库**
   ```bash
   git clone <isolated-repo-url>
   cd jq-backtest-standalone
   ```

2. **安装依赖**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   pip install -e .
   ```

3. **配置环境**
   ```bash
   cp .env.example .env
   # 编辑 .env 设置数据路径
   ```

4. **运行示例测试**
   ```bash
   pytest tests/ -v
   ```

### Phase 2: 核心实现 (5-7天)

#### 任务1: 实现CSV数据适配器 (`csv_adapter.py`)

**目标**: 将CSV文件转换为backtrader可用的数据格式

**关键点**:
- 读取CSV文件
- 处理复权数据
- 支持日线和分钟线
- 缓存机制

**验收标准**:
```python
# 测试代码
adapter = CSVDataFeedAdapter(data_provider)
data = adapter.load_data('000001.XSHE', start, end)
assert 'close' in data.columns
assert len(data) > 0
```

#### 任务2: 实现策略适配器 (`strategy.py`)

**目标**: 将JoinQuant策略代码适配到backtrader框架

**关键点**:
- 解析用户策略代码（initialize, handle_data）
- 实现API注入机制
- 管理订单生命周期
- 跟踪持仓和资金

**验收标准**:
```python
# 策略示例应该能正常运行
strategy_code = """
def initialize(context):
    g.security = '000001.XSHE'

def handle_data(context, data):
    price = data[g.security].close
    if price > 10:
        order(g.security, 100)
"""
# 应该能成功执行
```

#### 任务3: 实现回测引擎 (`engine.py`)

**目标**: 组织整个回测流程

**关键点**:
- 初始化backtrader
- 加载数据feeds
- 运行策略
- 计算回测指标
- 生成结果报告

**验收标准**:
- 能运行完整回测
- 输出符合接口规范的结果
- 包含所有必需指标

### Phase 3: 测试与优化 (2-3天)

1. **单元测试覆盖率 > 80%**
2. **集成测试通过**
3. **性能基准测试**
4. **文档完善**

---

## ✅ 验收标准

### 功能验收

#### 1. API兼容性测试
```python
# 测试聚宽API兼容性
def test_joinquant_api_compatibility():
    """确保所有JoinQuant API都能正常工作"""
    strategy = """
    def initialize(context):
        set_benchmark('000300.XSHG')
        set_order_cost(OrderCost(open_tax=0, close_tax=0.001))
        
    def handle_data(context, data):
        # 测试所有交易API
        order('000001.XSHE', 100)
        order_target('000001.XSHE', 200)
        order_value('000001.XSHE', 10000)
        order_target_value('000001.XSHE', 50000)
        
        # 测试数据API
        hist = history(5, '1d', 'close', ['000001.XSHE'])
        price = get_price('000001.XSHE')
    """
    
    result = service.run_backtest(
        strategy_code=strategy,
        start_date=datetime(2023, 1, 1),
        end_date=datetime(2023, 12, 31)
    )
    
    assert result['status'] == 'completed'
    assert 'final_value' in result
    assert 'sharpe_ratio' in result
```

#### 2. 结果格式验证
```python
def test_result_format():
    """验证返回结果格式"""
    result = run_backtest(...)
    
    # 必需字段
    required_fields = [
        'backtest_id', 'status', 'initial_cash', 'final_value',
        'total_return', 'sharpe_ratio', 'max_drawdown',
        'equity_curve', 'trades', 'positions'
    ]
    
    for field in required_fields:
        assert field in result
    
    # 数据类型检查
    assert isinstance(result['equity_curve'], list)
    assert isinstance(result['trades'], list)
    assert isinstance(result['total_return'], float)
```

#### 3. 性能基准测试
```python
def test_performance_benchmark():
    """性能测试"""
    import time
    
    start = time.time()
    result = run_backtest(
        strategy_code=sample_strategy,
        start_date=datetime(2020, 1, 1),
        end_date=datetime(2023, 12, 31),
        securities=['000001.XSHE']
    )
    elapsed = time.time() - start
    
    # 3年日线数据回测应在30秒内完成
    assert elapsed < 30
    assert result['status'] == 'completed'
```

### 集成验收

#### 准备集成包
```bash
# 打包模块
python scripts/prepare_integration.py

# 生成的集成包应包含：
integration_package/
├── jq_backtest/          # 所有源代码
├── tests/                # 测试用例
├── INTEGRATION_REPORT.md # 集成报告
└── CHANGELOG.md          # 变更日志
```

#### 集成测试
```bash
# 在主系统中运行集成测试
cd /path/to/main-system
cp -r integration_package/jq_backtest backend/services/
pytest tests/integration/test_jq_backtest_integration.py
```

---

## 📝 开发文档清单

### 需要提供给实习生的文档

1. **README.md** - 快速开始指南
2. **API_SPECIFICATION.md** - 详细API规范
3. **EXAMPLES.md** - 代码示例集
4. **INTEGRATION_GUIDE.md** - 集成指南
5. **JOINQUANT_API_REFERENCE.md** - JoinQuant API参考

### 实习生需要提交的文档

1. **DEVELOPMENT_LOG.md** - 开发日志
2. **TECHNICAL_DECISIONS.md** - 技术决策文档
3. **TESTING_REPORT.md** - 测试报告
4. **INTEGRATION_REPORT.md** - 集成准备报告

---

## 🔒 安全与隔离措施

### 代码隔离
1. ✅ 独立Git仓库
2. ✅ 不包含主系统任何业务逻辑
3. ✅ 只提供接口定义和示例

### 数据隔离
1. ✅ 使用脱敏的样本数据
2. ✅ 不包含真实用户数据
3. ✅ 数据量限制（最多1年日线数据）

### 访问控制
1. ✅ 只读访问接口定义
2. ✅ 无法访问主系统数据库
3. ✅ 无法访问主系统API

---

## 🔄 集成流程

### Step 1: 代码审查
```bash
# 审查实习生提交的代码
git checkout intern-dev-branch
./scripts/code_review.sh
```

### Step 2: 本地集成测试
```bash
# 在隔离环境测试
./scripts/validate_integration.sh
```

### Step 3: 替换现有模块
```bash
# 备份现有模块
mv backend/services/jq_backtest backend/services/jq_backtest.backup

# 复制新模块
cp -r intern-delivery/jq_backtest backend/services/

# 运行完整测试套件
pytest tests/integration/ -v
```

### Step 4: 性能对比
```python
# 对比新旧版本性能
python scripts/benchmark_comparison.py \
  --old backend/services/jq_backtest.backup \
  --new backend/services/jq_backtest
```

### Step 5: 灰度发布
1. 先在测试环境运行1周
2. 监控性能指标
3. 逐步迁移生产流量

---

## 📊 监控指标

### 开发阶段
- [ ] 测试覆盖率 > 80%
- [ ] 所有API兼容性测试通过
- [ ] 性能基准达标
- [ ] 文档完整性检查通过

### 集成阶段
- [ ] 集成测试100%通过
- [ ] 无性能退化
- [ ] 结果准确性验证（与旧版对比误差<0.1%）
- [ ] 内存泄漏检查通过

---

## 📞 支持与沟通

### 日常沟通
- **周报**: 每周五提交进展报告
- **Daily Standup**: 每天同步进度和问题
- **技术讨论**: 通过Issue或文档提问

### 技术支持
- **接口疑问**: 查看API_SPECIFICATION.md或提Issue
- **数据问题**: 检查测试数据格式文档
- **集成问题**: 参考INTEGRATION_GUIDE.md

---

## 🎯 里程碑计划

| 周次 | 里程碑 | 交付物 |
|------|--------|--------|
| Week 1 | 环境搭建 + 需求理解 | 环境搭建完成报告 |
| Week 2 | CSV适配器实现 | csv_adapter.py + 单元测试 |
| Week 3 | 策略适配器实现 | strategy.py + 单元测试 |
| Week 4 | 回测引擎实现 | engine.py + 集成测试 |
| Week 5 | 测试与优化 | 完整测试报告 |
| Week 6 | 文档与集成准备 | 集成包 + 文档 |

---

## 📋 交付清单

### 最终交付物
- [x] 完整源代码（jq_backtest/）
- [x] 单元测试（tests/）
- [x] 集成测试用例
- [x] 开发文档
- [x] API文档
- [x] 集成指南
- [x] 性能测试报告
- [x] 代码覆盖率报告

### 集成后验证
- [ ] 主系统所有依赖该模块的功能正常
- [ ] 性能无退化
- [ ] 回测结果准确性验证通过
- [ ] 监控指标正常

---

## 🚀 下一步行动

### 立即执行
1. [ ] 创建隔离Git仓库
2. [ ] 准备初始代码包
3. [ ] 生成样本测试数据
4. [ ] 编写详细的API文档
5. [ ] 设置CI/CD流水线

### 准备材料
1. [ ] 实习生培训PPT
2. [ ] 代码审查Checklist
3. [ ] 集成测试方案
4. [ ] 监控Dashboard配置

---

## 附录

### A. 依赖清单 (pyproject.toml)

```toml
[project]
name = "jq-backtest-standalone"
version = "1.0.0"
description = "JoinQuant-compatible backtest engine (standalone)"
requires-python = ">=3.10"

dependencies = [
    "pandas>=2.1",
    "numpy>=1.25",
    "backtrader>=1.9.78.123",
    "loguru>=0.7",
    "pytz>=2023.3",
    "pytest>=7.4",
    "pytest-cov>=4.1",
]
```

### B. 环境配置 (.env.example)

```bash
# 数据路径配置
DATA_ROOT=/path/to/sample/data
CACHE_DIR=/path/to/cache

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=/path/to/logs/backtest.log

# 性能配置
MAX_WORKERS=4
CACHE_ENABLED=true
```

### C. Docker开发环境

```dockerfile
# Dockerfile
FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

CMD ["python", "-m", "pytest", "tests/"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  jq-backtest:
    build: .
    volumes:
      - ./jq_backtest:/app/jq_backtest
      - ./tests:/app/tests
      - ./data:/app/data
    environment:
      - DATA_ROOT=/app/data
      - LOG_LEVEL=DEBUG
```

---

## 总结

这个方案确保了：
1. ✅ **完全隔离**: 实习生无法接触主系统核心代码
2. ✅ **接口统一**: 遵循相同的API规范
3. ✅ **独立开发**: 有完整的开发和测试环境
4. ✅ **无缝集成**: 开发完成后可直接替换
5. ✅ **质量保证**: 有明确的验收标准和测试要求

通过这个方案，实习生可以专注于核心回测引擎的实现，而不需要了解整个系统的复杂架构，同时保证了代码质量和集成的顺利进行。
