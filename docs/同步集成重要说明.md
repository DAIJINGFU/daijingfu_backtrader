# 同步集成重要说明 ⚠️

## 🔄 正确的开发流程

### ❌ 错误做法（会破坏同步）

```bash
# 直接修改生成的文件
vi jq-backtest-standalone-full/backend/data_provider/simple_provider.py
```

**问题**：这会导致生成脚本和实际代码不一致，下次运行脚本会覆盖修改！

### ✅ 正确做法（保持同步）

```bash
# 1. 修改生成脚本
vi scripts/generate_isolated_package_full.sh

# 2. 重新生成隔离包
rm -rf jq-backtest-standalone-full
./scripts/generate_isolated_package_full.sh

# 3. 测试验证
cd jq-backtest-standalone-full
python3 test_simple_provider.py
```

**优点**：
- ✅ 脚本是单一真相源（Single Source of Truth）
- ✅ 每次生成都保持一致
- ✅ 便于版本控制和回滚
- ✅ 自动化集成无冲突

---

## 📋 文件来源清单

### 由脚本生成（不要手动修改）

```
jq-backtest-standalone-full/
├── backend/
│   ├── data_provider/
│   │   ├── __init__.py           ← 脚本生成
│   │   └── simple_provider.py    ← 脚本生成 ⚠️
│   ├── api_server.py              ← 脚本生成
│   └── jq_backtest/               ← 从主系统复制
│
├── frontend/
│   ├── package.json               ← 脚本生成
│   ├── vite.config.ts            ← 脚本生成
│   └── src/views/                 ← 从主系统复制
│
├── interfaces/                    ← 脚本生成
├── README.md                      ← 脚本生成
└── pyproject.toml                 ← 脚本生成
```

### 实习生需要实现（可以修改）

```
jq-backtest-standalone-full/
├── backend/
│   └── jq_backtest/
│       ├── engine.py              ← 需要实现 ✏️
│       ├── strategy.py            ← 需要实现 ✏️
│       └── csv_adapter.py         ← 需要实现 ✏️
│
├── tests/                         ← 添加测试 ✏️
└── examples/                      ← 添加示例 ✏️
```

---

## 🔧 修改工作流程

### 场景1：修改数据提供者

```bash
# 步骤1：修改脚本中的 simple_provider.py 部分
vi scripts/generate_isolated_package_full.sh

# 找到这一行：
# cat > "$OUTPUT_DIR/backend/data_provider/simple_provider.py" << 'EOF'

# 在 'EOF' 之间修改代码

# 步骤2：重新生成
rm -rf jq-backtest-standalone-full
./scripts/generate_isolated_package_full.sh

# 步骤3：测试
cd jq-backtest-standalone-full
python3 test_simple_provider.py
```

### 场景2：修改API服务器

```bash
# 步骤1：修改脚本中的 api_server.py 部分
vi scripts/generate_isolated_package_full.sh

# 找到：
# cat > "$OUTPUT_DIR/backend/api_server.py" << 'EOF'

# 步骤2：重新生成和测试
rm -rf jq-backtest-standalone-full
./scripts/generate_isolated_package_full.sh
```

### 场景3：实习生实现引擎代码

```bash
# ✅ 这些文件可以直接修改（不是脚本生成的完整实现）
vi jq-backtest-standalone-full/backend/jq_backtest/engine.py
vi jq-backtest-standalone-full/backend/jq_backtest/strategy.py
vi jq-backtest-standalone-full/backend/jq_backtest/csv_adapter.py

# ✅ 测试代码也可以直接添加
vi jq-backtest-standalone-full/tests/test_engine.py
```

---

## 🔄 集成回主仓库

### 使用同步脚本

```bash
# 步骤1：检查同步状态
./scripts/sync_tools/check_sync_status.sh

# 步骤2：执行自动化集成
./scripts/sync_tools/sync_from_jq_backtest.sh

# 步骤3：验证集成
cd /tmp/main-repo
pytest tests/
```

**重要**：同步脚本会：
- ✅ 自动调整导入路径
- ✅ 合并实习生实现的代码
- ✅ 保留主系统的基础设施
- ✅ 运行测试验证

---

## 📊 版本控制策略

### 主仓库（starquant4）

```bash
# 脚本是版本控制的核心
git add scripts/generate_isolated_package_full.sh
git commit -m "feat: update simple_provider with format detection"

# 不要提交生成的目录
echo "jq-backtest-standalone-full/" >> .gitignore
```

### 独立仓库（starquant4-backtest）

```bash
# 实习生开发的代码需要版本控制
cd jq-backtest-standalone-full
git init
git add backend/jq_backtest/engine.py
git add backend/jq_backtest/strategy.py
git add tests/
git commit -m "feat: implement backtest engine"
```

---

## ⚠️ 常见问题

### Q: 我不小心手动修改了生成的文件，怎么办？

**A**: 两个选择：

1. **回退修改**（推荐）：
   ```bash
   rm -rf jq-backtest-standalone-full
   ./scripts/generate_isolated_package_full.sh
   ```

2. **同步修改到脚本**：
   ```bash
   # 对比差异
   diff jq-backtest-standalone-full/backend/data_provider/simple_provider.py \
        <(./scripts/generate_isolated_package_full.sh | tail -n +XXX)
   
   # 手动更新脚本
   vi scripts/generate_isolated_package_full.sh
   ```

### Q: 如何知道哪些文件是脚本生成的？

**A**: 看文件头部注释或运行：

```bash
# 查看生成日志
./scripts/generate_isolated_package_full.sh 2>&1 | tee generation.log

# 脚本会明确标注：
# "生成配置文件..."
# "复制前端页面..."
```

### Q: 实习生提交的代码如何集成？

**A**: 使用自动化集成脚本：

```bash
# 1. 实习生推送到独立仓库
cd jq-backtest-standalone-full
git push origin main

# 2. 主系统拉取并集成
cd /path/to/main-repo
./scripts/sync_tools/sync_from_jq_backtest.sh
```

---

## ✅ 最佳实践检查清单

开发前：
- [ ] 理解哪些文件由脚本生成
- [ ] 理解哪些文件需要实现
- [ ] 熟悉重新生成流程

开发中：
- [ ] 只修改需要实现的文件
- [ ] 不直接修改脚本生成的文件
- [ ] 定期测试验证

开发后：
- [ ] 提交前检查修改的文件
- [ ] 使用集成脚本而非手动合并
- [ ] 运行完整测试套件

---

## 📞 求助

如果遇到同步问题：

1. **查看文档**：
   - `docs/聚宽回测模块_双向同步集成方案.md`
   - `docs/聚宽回测模块_集成检查清单.md`

2. **运行诊断**：
   ```bash
   ./scripts/sync_tools/check_sync_status.sh
   ```

3. **重新生成**（最后手段）：
   ```bash
   rm -rf jq-backtest-standalone-full
   ./scripts/generate_isolated_package_full.sh
   ```

---

**记住：脚本是单一真相源！** 🎯
