# 回测后端迁移计划文档

## 一、目标

将 `backend/backtest_origin` 目录下的成熟回测后端整体迁移/替换为 `backend/jq_backtest`，使项目后端统一采用 `backtest_origin` 方案，保证接口兼容和功能完整。

## 二、迁移前准备

**特别要求：本次迁移过程中，不允许改动 backend 文件夹以外的任何文件，确保只迁移回测后端！**

1. 备份 `backend/jq_backtest` 和 `backend/backtest_origin` 目录。
2. 梳理 `backtest_origin` 和 `jq_backtest` 的依赖，确保迁移后依赖完整。
3. 列出 `jq_backtest` 目前对外暴露的主要接口，并对比 `backtest_origin` 的接口，标记差异。

## 三、迁移实施步骤

1. **清空或备份 `backend/jq_backtest` 目录内容**

   - 将 `backend/jq_backtest` 目录下所有文件和子目录备份到安全位置（如 `jq_backtest_backup`）。
   - 确认备份无误后，清空 `jq_backtest` 目录。

2. **复制 `backtest_origin` 内容到 `jq_backtest`**

   - 将 `backend/backtest_origin` 目录下所有文件和子目录（包括隐藏文件、`__init__.py`等）完整复制到 `backend/jq_backtest`。
   - 保持原有目录结构不变，确保无遗漏。

3. **全局替换 import 路径**

   - 在 `backend/jq_backtest` 目录下，递归查找所有文件中的 `backtest_origin`，将其批量替换为 `jq_backtest`。
   - 包括 import 语句、包名、模块名、硬编码路径等。
   - 检查替换后是否有语法错误或路径错误。

4. **检查和修正相对/绝对导入**

   - 检查所有 Python 文件中的相对导入（如 `from . import xxx`）和绝对导入，确保迁移后路径正确。
   - 对于跨目录导入，必要时调整为相对导入或修正 sys.path 相关代码。

5. **对外接口适配与兼容**

   - 对比迁移前后 `jq_backtest` 对外暴露的 API、类、方法，确保接口名称、参数、返回值等保持一致。
   - 如有接口差异，优先适配迁移后的 `jq_backtest`，必要时编写适配层（wrapper）或补充兼容接口。
   - 保证前端及其他依赖后端的模块调用不受影响。

6. **配置文件与依赖调整**

   - 检查 `jq_backtest` 目录下是否有配置文件（如 `.env`、yaml、json、ini 等），如有需要迁移的配置，进行合并或替换。
   - 检查 `pyproject.toml`、`requirements.txt`，补充 `backtest_origin` 所需依赖，仅限 backend 目录内的依赖调整。

7. **迁移和补充测试用例**

   - 将 `backtest_origin` 目录下的测试用例（如 test\_\*.py）一并迁移到 `jq_backtest` 或相关测试目录。
   - 检查测试用例中的 import 路径，确保指向 `jq_backtest`。
   - 补充/调整测试用例，覆盖主要功能、接口、边界情况。

8. **本地验证**

   - 在 backend 目录下运行所有测试用例，确保全部通过。
   - 检查迁移后代码结构、接口文档、依赖说明等是否同步更新。

9. **数据接口主入口切换与 data_provider 处理**
   - 迁移后，所有新的数据接口调用应以 `modules/s_2_data_loader` 作为主入口，逐步替换原有 `SimpleCSVDataProvider` 的用法。
   - `backend/data_provider` 文件夹及相关代码仅保留兼容性说明，不再推荐新代码使用。
   - 可在 `data_provider` 相关文件头部添加注释，标明“已废弃，建议使用 jq_backtest/modules/s_2_data_loader 相关接口”。

## 四、迁移后验证

1. 运行所有迁移后的单元测试，确保全部通过。
2. 启动前后端联调，验证主要业务流程是否正常。
3. 对比迁移前后回测速度、资源占用等指标。
4. 若迁移后出现严重问题，可快速回滚至迁移前版本。

## 五、注意事项

## 六、后续优化建议

- 持续完善测试用例，提升系统健壮性。

- 逐步清理和移除 `backend/data_provider` 及相关兼容代码，待新数据接口稳定后彻底废弃。
